<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f9f9f9;
    }
    h1 { text-align: center; color: #2c3e50; margin-top: 0; }
    .controls {
      display: flex; gap: 10px; flex-wrap: wrap;
      padding: 12px; background: white; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 16px;
    }
    input, button {
      padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px;
    }
    button {
      background: #3498db; color: white; font-weight: bold; cursor: pointer;
    }
    button:hover { background: #2980b9; }
    button.danger { background: #e74c3c; }
    button.danger:hover { background: #c0392b; }
    #map {
      height: 600px; width: 100%;
      border: 1px solid #ddd; border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #output {
      margin-top: 16px; padding: 12px;
      background: white; border-radius: 8px;
      font-family: monospace; white-space: pre-wrap;
      max-height: 200px; overflow: auto;
    }
  </style>
</head>
<body>
  <h1>üß≠ –†–∞–∑–º–µ—Ç–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ —ç—Ç–∞–∂–∞–º</h1>

  <div class="controls">
    <select id="floor-select"></select>
    <button id="btn-load-floor">–ó–∞–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–∂</button>
    <span style="flex:1"></span>
    <input type="text" id="room-number" placeholder="‚Ññ –∫–∞–±–∏–Ω–µ—Ç–∞ (–Ω–∞–ø—Ä. 205)" />
    <button id="btn-set-hall">–û—Ç–º–µ—Ç–∏—Ç—å —Ö–æ–ª–ª</button>
    <button id="btn-start-route">–ù–∞—á–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
    <button id="btn-undo" title="–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É (‚å´)">–û—Ç–º–µ–Ω–∏—Ç—å</button>
    <button id="btn-finish">–ó–∞–≤–µ—Ä—à–∏—Ç—å (–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç)</button>
    <button id="btn-cancel" class="danger">–û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>
  </div>

  <div style="display:flex; gap:16px; align-items:flex-start;">
    <div style="flex:1 1 auto;">
      <div id="map"></div>
      <div id="output">–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–∂ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —ç—Ç–∞–∂". –ü–æ—Ç–æ–º –æ—Ç–º–µ—Ç—å—Ç–µ —Ö–æ–ª–ª –∏ —Å—Ç—Ä–æ–π—Ç–µ –º–∞—Ä—à—Ä—É—Ç—ã.</div>
    </div>
    <div style="width:320px; background:white; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:12px;">
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
        <button id="btn-export">üíæ –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <button id="btn-import">üìÇ –ò–º–ø–æ—Ä—Ç JSON</button>
        <input type="file" id="file-input" accept="application/json" style="display:none" />
        <button id="btn-clear-floor" class="danger">–û—á–∏—Å—Ç–∏—Ç—å —ç—Ç–∞–∂</button>
        <button id="btn-clear-all" class="danger">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      </div>
      <div style="font-weight:bold; margin-bottom:6px;">–ö–∞–±–∏–Ω–µ—Ç—ã —ç—Ç–∞–∂–∞</div>
      <div id="room-list" style="max-height:420px; overflow:auto; border:1px solid #eee; border-radius:6px; padding:6px;">
        <div style="color:#888">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞–±–∏–Ω–µ—Ç–æ–≤</div>
      </div>
    </div>
  </div>

  <script>
    // === –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–ø–æ —ç—Ç–∞–∂–∞–º) ===
    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å–µ–≥–¥–∞ –∫–∞–∫ [y, x] (lat, lng –≤ Leaflet CRS.Simple)
    const DEFAULT_FLOOR_FILES = ['1.png','2.png','3.png','4.png'];

    const appState = {
      floors: {
        // [floorId]: { image:{path,width,height}, hall:[y,x]|null, rooms:{ [room]:{coords:[y,x], route:[[y,x],...] } } }
      },
      activeFloor: null
    };

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã (–±–µ–∑ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∑–∏–º –ø–æ–∑–∂–µ) ===
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -4,
      maxZoom: 5
    });

    let imageOverlay = null;
    let imageBounds = null;

    // –¢–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑–º–µ—Ç–∫–∏
    let mode = 'idle'; // idle | setHall | drawing
    let currentRoomNumber = null;
    let currentRoutePoints = [];
    let currentPolyline = null;
    let tempMarkers = [];

    // === DOM —ç–ª–µ–º–µ–Ω—Ç—ã ===
    const floorSelect = document.getElementById('floor-select');
    const btnLoadFloor = document.getElementById('btn-load-floor');
    const btnSetHall = document.getElementById('btn-set-hall');
    const btnStartRoute = document.getElementById('btn-start-route');
    const btnUndo = document.getElementById('btn-undo');
    const btnFinish = document.getElementById('btn-finish');
    const btnCancel = document.getElementById('btn-cancel');
    const btnExport = document.getElementById('btn-export');
    const btnImport = document.getElementById('btn-import');
    const fileInput = document.getElementById('file-input');
    const btnClearFloor = document.getElementById('btn-clear-floor');
    const btnClearAll = document.getElementById('btn-clear-all');
    const roomInput = document.getElementById('room-number');
    const roomListEl = document.getElementById('room-list');

    const outputEl = document.getElementById('output');

    // === –£—Ç–∏–ª–∏—Ç—ã ===
    function setOutput(msg) { outputEl.textContent = msg; }
    function pushOutput(msg) { outputEl.textContent += `\n${msg}`; }

    function persist() {
      try { localStorage.setItem('route_builder_state_v2', JSON.stringify(appState)); } catch(e) {}
    }
    function restore() {
      const raw = localStorage.getItem('route_builder_state_v2');
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        if (data && data.floors) Object.assign(appState, data);
      } catch(e) {}
    }

    function ensureFloor(floorId, imagePath) {
      if (!appState.floors[floorId]) {
        appState.floors[floorId] = { image: { path: imagePath || DEFAULT_FLOOR_FILES[Number(floorId)-1] || imagePath }, hall: null, rooms: {} };
      } else if (imagePath) {
        appState.floors[floorId].image.path = imagePath;
      }
    }

    function resetDrawingState() {
      mode = 'idle';
      currentRoomNumber = null;
      currentRoutePoints = [];
      if (currentPolyline) { map.removeLayer(currentPolyline); currentPolyline = null; }
      tempMarkers.forEach(m => map.removeLayer(m));
      tempMarkers = [];
      updateButtons();
    }

    function updateButtons() {
      const hasFloor = !!appState.activeFloor && !!appState.floors[appState.activeFloor];
      btnSetHall.disabled = !hasFloor || mode === 'drawing';
      btnStartRoute.disabled = !hasFloor || mode === 'setHall' || !roomInput.value.trim();
      btnUndo.disabled = mode !== 'drawing' || currentRoutePoints.length === 0;
      btnFinish.disabled = mode !== 'drawing' || currentRoutePoints.length === 0;
      btnCancel.disabled = mode === 'idle';
      btnClearFloor.disabled = !hasFloor;
      btnExport.disabled = Object.keys(appState.floors).length === 0;
    }

    function renderRoomList() {
      const floor = appState.floors[appState.activeFloor];
      roomListEl.innerHTML = '';
      if (!floor || Object.keys(floor.rooms).length === 0) {
        const empty = document.createElement('div');
        empty.style.color = '#888';
        empty.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞–±–∏–Ω–µ—Ç–æ–≤';
        roomListEl.appendChild(empty);
        return;
      }
      Object.entries(floor.rooms).forEach(([room, data]) => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '8px';
        row.style.padding = '6px';
        row.style.borderBottom = '1px solid #eee';

        const btnShow = document.createElement('button');
        btnShow.textContent = 'üëÅ';
        btnShow.title = '–ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç';
        btnShow.onclick = () => { showRoomRoute(room); };

        const input = document.createElement('input');
        input.value = room;
        input.style.flex = '1';
        input.onchange = () => {
          const newNum = input.value.trim();
          if (!newNum || newNum === room) return;
          if (floor.rooms[newNum]) { alert('–¢–∞–∫–æ–π –Ω–æ–º–µ—Ä —É–∂–µ –µ—Å—Ç—å –Ω–∞ —ç—Ç–∞–∂–µ'); input.value = room; return; }
          floor.rooms[newNum] = floor.rooms[room];
          delete floor.rooms[room];
          persist();
          renderRoomList();
        };

        const btnDel = document.createElement('button');
        btnDel.textContent = 'üóë';
        btnDel.className = 'danger';
        btnDel.title = '–£–¥–∞–ª–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç';
        btnDel.onclick = () => {
          if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç ${room}?`)) return;
          delete floor.rooms[room];
          persist();
          redrawAll();
          renderRoomList();
        };

        row.appendChild(btnShow);
        row.appendChild(input);
        row.appendChild(btnDel);
        roomListEl.appendChild(row);
      });
    }

    function showRoomRoute(room) {
      const floor = appState.floors[appState.activeFloor];
      if (!floor || !floor.rooms[room]) return;
      redrawAll();
      const route = floor.rooms[room].route;
      L.polyline(route, { color: 'red', weight: 3 }).addTo(map);
      const roomCoords = floor.rooms[room].coords;
      L.marker(roomCoords).bindPopup(`<b>–ö–∞–±–∏–Ω–µ—Ç ${room}</b>`).addTo(map).openPopup();
      setOutput(`–ü–æ–∫–∞–∑–∞–Ω –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –∫–∞–±–∏–Ω–µ—Ç–∞ ${room}`);
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ç–∞–∂–∞ (–∫–∞—Ä—Ç–∏–Ω–∫–∏) ===
    async function loadFloorImage(floorId) {
      const floor = appState.floors[floorId];
      if (!floor || !floor.image || !floor.image.path) { alert('–ù–µ –∑–∞–¥–∞–Ω –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é —ç—Ç–∞–∂–∞'); return; }
      const path = floor.image.path;
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Ä–∞–∑–º–µ—Ä—ã
      const img = new Image();
      const size = await new Promise((resolve, reject) => {
        img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
        img.onerror = () => reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ' + path));
        img.src = path;
      }).catch(e => { alert(e.message); });
      if (!size) return;
      floor.image.width = size.width;
      floor.image.height = size.height;

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ª–æ–∂–∫—É
      const bounds = [[0,0],[size.height, size.width]];
      imageBounds = bounds;
      if (imageOverlay) map.removeLayer(imageOverlay);
      imageOverlay = L.imageOverlay(path, bounds).addTo(map);
      map.fitBounds(bounds);
      redrawAll();
      renderRoomList();
      setOutput(`–≠—Ç–∞–∂ ${floorId} –∑–∞–≥—Ä—É–∂–µ–Ω (${size.width}√ó${size.height}).`);
      persist();
    }

    function redrawAll() {
      // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —Å–ª–æ—ë–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö
      map.eachLayer(l => {
        if (l !== imageOverlay) map.removeLayer(l);
      });
      tempMarkers = [];
      currentPolyline = null;

      const floor = appState.floors[appState.activeFloor];
      if (!floor) return;
      if (floor.hall) {
        L.circle(floor.hall, { color: 'green', fillColor: '#0f0', fillOpacity: 0.5, radius: 20 }).addTo(map);
      }
      Object.entries(floor.rooms).forEach(([room, data]) => {
        L.polyline(data.route, { color: 'red', weight: 3 }).addTo(map);
        L.marker(data.coords).bindPopup(`<b>–ö–∞–±–∏–Ω–µ—Ç ${room}</b>`).addTo(map);
      });
    }

    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–µ–∂–∏–º–æ–≤ ===
    function enterSetHall() {
      if (!appState.activeFloor) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —ç—Ç–∞–∂'); return; }
      if (mode === 'drawing') { if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç?')) return; resetDrawingState(); }
      mode = 'setHall';
      setOutput('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –•–û–õ–õ.');
      updateButtons();
    }

    function enterDrawing() {
      if (!appState.activeFloor) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —ç—Ç–∞–∂'); return; }
      const room = roomInput.value.trim();
      if (!room) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞'); return; }
      const floor = appState.floors[appState.activeFloor];
      if (!floor.hall) { alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–º–µ—Ç—å—Ç–µ —Ö–æ–ª–ª'); return; }
      if (floor.rooms[room]) { if (!confirm('–ö–∞–±–∏–Ω–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç?')) return; }
      resetDrawingState();
      mode = 'drawing';
      currentRoomNumber = room;
      currentRoutePoints = [floor.hall];
      tempMarkers.push(L.circle(floor.hall, { color: 'green', fillColor: '#0f0', fillOpacity: 0.5, radius: 20 }).addTo(map));
      currentPolyline = L.polyline(currentRoutePoints, { color: 'blue', weight: 2, dashArray: '5,5' }).addTo(map);
      setOutput(`–†–µ–∂–∏–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è: –∫–∞–±–∏–Ω–µ—Ç ${room}. –ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–æ—Ä–∏–¥–æ—Ä–∞–º, ‚å´ ‚Äî –æ—Ç–º–µ–Ω–∞ —Ç–æ—á–∫–∏, –ó–∞–≤–µ—Ä—à–∏—Ç—å ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç.`);
      updateButtons();
    }

    function addPointAt(latlng) {
      if (mode !== 'drawing') return;
      const point = [Math.round(latlng.lat), Math.round(latlng.lng)];
      currentRoutePoints.push(point);
      tempMarkers.push(L.circle(point, { color: 'blue', fillColor: '#3498db', fillOpacity: 0.3, radius: 10 }).addTo(map));
      if (currentPolyline) map.removeLayer(currentPolyline);
      currentPolyline = L.polyline(currentRoutePoints, { color: 'blue', weight: 2, dashArray: '5,5' }).addTo(map);
      pushOutput(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–æ—á–∫–∞: [${point[0]}, ${point[1]}]`);
      updateButtons();
    }

    function undoPoint() {
      if (mode !== 'drawing' || currentRoutePoints.length === 0) return;
      currentRoutePoints.pop();
      const marker = tempMarkers.pop();
      if (marker) map.removeLayer(marker);
      if (currentPolyline) map.removeLayer(currentPolyline);
      if (currentRoutePoints.length > 0) {
        currentPolyline = L.polyline(currentRoutePoints, { color: 'blue', weight: 2, dashArray: '5,5' }).addTo(map);
      } else {
        currentPolyline = null;
      }
      updateButtons();
    }

    function finishRouteAt(latlng) {
      if (mode !== 'drawing' || currentRoutePoints.length < 1) { alert('–î–æ–±–∞–≤—å—Ç–µ —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞'); return; }
      const roomCoords = [Math.round(latlng.lat), Math.round(latlng.lng)];
      currentRoutePoints.push(roomCoords);
      const floor = appState.floors[appState.activeFloor];
      floor.rooms[currentRoomNumber] = { coords: roomCoords, route: [...currentRoutePoints] };
      persist();
      redrawAll();
      setOutput(`‚úÖ –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è ${currentRoomNumber} –∑–∞–≤–µ—Ä—à—ë–Ω.`);
      resetDrawingState();
      renderRoomList();
    }

    function cancelCurrent() {
      if (mode === 'idle') return;
      if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–∞–∑–º–µ—Ç–∫—É?')) return;
      resetDrawingState();
      setOutput('–¢–µ–∫—É—â–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.');
    }

    // === –°–ª—É—à–∞—Ç–µ–ª–∏ –∫–∞—Ä—Ç—ã ===
    map.on('click', (e) => {
      if (!appState.activeFloor) return;
      if (mode === 'setHall') {
        const p = [Math.round(e.latlng.lat), Math.round(e.latlng.lng)];
        appState.floors[appState.activeFloor].hall = p;
        persist();
        redrawAll();
        setOutput(`–•–æ–ª–ª –æ—Ç–º–µ—á–µ–Ω: [${p[0]}, ${p[1]}]`);
        mode = 'idle';
        updateButtons();
        return;
      }
      if (mode === 'drawing') {
        addPointAt(e.latlng);
      }
    });

    map.on('contextmenu', (e) => {
      // –ü–ö–ú ‚Äî –±—ã—Å—Ç—Ä–∞—è –æ—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏ –≤ —Ä–µ–∂–∏–º–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è
      if (mode === 'drawing') { e.originalEvent.preventDefault(); undoPoint(); }
    });

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ ‚Äî —Å–ª–µ–¥—É—é—â–∞—è —Ç–æ—á–∫–∞ —Å—Ç–∞–Ω–µ—Ç –∫–∞–±–∏–Ω–µ—Ç–æ–º
    let finishArmed = false;
    btnFinish.addEventListener('click', () => {
      if (mode !== 'drawing') return;
      finishArmed = true;
      setOutput('–ö–ª–∏–∫–Ω–∏—Ç–µ –ø–æ –∫–∞–±–∏–Ω–µ—Ç—É, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç.');
    });
    map.on('click', (e) => {
      if (finishArmed && mode === 'drawing') {
        finishArmed = false;
        finishRouteAt(e.latlng);
      }
    });

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç—Ç–∞–∂–∞–º–∏ ===
    function populateFloorSelect() {
      floorSelect.innerHTML = '';
      for (let i=1;i<=DEFAULT_FLOOR_FILES.length;i++) {
        const opt = document.createElement('option');
        opt.value = String(i);
        opt.textContent = `–≠—Ç–∞–∂ ${i} (${DEFAULT_FLOOR_FILES[i-1]})`;
        floorSelect.appendChild(opt);
      }
      if (!appState.activeFloor) appState.activeFloor = '1';
      floorSelect.value = appState.activeFloor;
    }

    btnLoadFloor.addEventListener('click', async () => {
      const nextFloor = floorSelect.value;
      if (mode !== 'idle') {
        const ok = confirm('–í—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–∑–º–µ—Ç–∫–∏. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —ç—Ç–∞–∂ –∏ –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é?');
        if (!ok) return;
        resetDrawingState();
      }
      appState.activeFloor = nextFloor;
      ensureFloor(nextFloor, DEFAULT_FLOOR_FILES[Number(nextFloor)-1]);
      await loadFloorImage(nextFloor);
    });

    // –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    btnSetHall.addEventListener('click', enterSetHall);
    btnStartRoute.addEventListener('click', enterDrawing);
    btnUndo.addEventListener('click', undoPoint);
    btnCancel.addEventListener('click', cancelCurrent);

    // –û—á–∏—Å—Ç–∫–∏
    btnClearFloor.addEventListener('click', () => {
      if (!appState.activeFloor) return;
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–∂? –•–æ–ª–ª –∏ –≤—Å–µ –∫–∞–±–∏–Ω–µ—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
      const f = appState.floors[appState.activeFloor];
      if (f) { f.hall = null; f.rooms = {}; }
      resetDrawingState();
      redrawAll();
      renderRoomList();
      persist();
      setOutput('–≠—Ç–∞–∂ –æ—á–∏—â–µ–Ω.');
    });
    btnClearAll.addEventListener('click', () => {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —ç—Ç–∞–∂–∏ –∏ —Ä–∞–∑–º–µ—Ç–∫—É?')) return;
      appState.floors = {};
      appState.activeFloor = '1';
      resetDrawingState();
      redrawAll();
      renderRoomList();
      persist();
      setOutput('–í—Å—ë –æ—á–∏—â–µ–Ω–æ.');
    });

    // –≠–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç
    btnExport.addEventListener('click', () => {
      const data = { floors: appState.floors };
      const jsonStr = JSON.stringify(data, null, 2);
      outputEl.textContent = jsonStr;
      const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'floors_routes.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
    btnImport.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const text = await file.text();
      try {
        const data = JSON.parse(text);
        if (!data.floors) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        appState.floors = data.floors;
        appState.activeFloor = Object.keys(appState.floors)[0] || '1';
        persist();
        populateFloorSelect();
        ensureFloor(appState.activeFloor);
        await loadFloorImage(appState.activeFloor);
        setOutput('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã.');
      } catch(err) {
        alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message);
      } finally {
        fileInput.value = '';
      }
    });

    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' || e.key === 'Delete') {
        if (mode === 'drawing') { e.preventDefault(); undoPoint(); }
      }
      if (e.key.toLowerCase() === 'h') { enterSetHall(); }
      if (e.key.toLowerCase() === 's') { enterDrawing(); }
      if (e.key.toLowerCase() === 'f') { btnFinish.click(); }
      if (e.key.toLowerCase() === 'c') { cancelCurrent(); }
    });

    // –ê–≤—Ç–æ–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
    restore();
    populateFloorSelect();
    ensureFloor(appState.activeFloor, DEFAULT_FLOOR_FILES[Number(appState.activeFloor)-1]);
    // –ü–æ–ø—Ä–æ–±—É–µ–º —Å—Ä–∞–∑—É –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç—Ç–∞–∂, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—É—Ç—å
    loadFloorImage(appState.activeFloor);
    updateButtons();
  </script>
</body>
</html>